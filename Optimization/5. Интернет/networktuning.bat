@echo off

echo Make sure to run this script as Administrator!

powershell -Command "Get-ChildItem -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Class\{4d36e972-e325-11ce-bfc1-08002be10318}' -ErrorAction SilentlyContinue | Where-Object { $_.PSChildName -match '^\d{4}$' } | ForEach-Object { $props = @('SipsEnabled','*SipsEnabled','EEE','*EEE','ReduceSpeedOnPowerDown','*ReduceSpeedOnPowerDown','ULPMode','*ULPMode','EEELinkAdvertisement','*EEELinkAdvertisement','EnableGreenEthernet','*EnableGreenEthernet','AdvancedEEE','*AdvancedEEE','GigaLite','*GigaLite','PowerSavingMode','*PowerSavingMode','ASPM','*ASPM','SelectiveSuspend','*SelectiveSuspend'); $path = $_.PSPath; $itemProps = Get-ItemProperty -Path $path; foreach ($prop in $props) { if ($itemProps.PSObject.Properties.Name -contains $prop) { if ($itemProps.$prop -eq 0) { Write-Host \"Property $prop in $($_.Name) already zero; no change needed.\" } else { Write-Host \"Changing $prop in $($_.Name) from [$($itemProps.$prop)] to 0\"; Set-ItemProperty -Path $path -Name $prop -Value 0 } } } }"

powershell -NoProfile -Command "$devices = Get-WmiObject Win32_PnPEntity; $powerMgmt = Get-WmiObject MSPower_DeviceEnable -Namespace root\wmi; foreach ($p in $powerMgmt){$IN = $p.InstanceName.ToUpper(); foreach ($h in $devices){$PNPDI = $h.PNPDeviceID; if ($IN -like \"*$PNPDI*\"){$p.enable = $False; $p.psbase.put()}}}"
powershell -NoProfile -Command "Get-NetAdapter -Physical | Get-NetAdapterPowerManagement -ErrorAction SilentlyContinue | Where-Object AllowComputerToTurnOffDevice -ne 'Unsupported' | ForEach-Object { $_.AllowComputerToTurnOffDevice = 'Disabled'; $_ | Set-NetAdapterPowerManagement }; if (Get-CimClass -Namespace root\wmi -ClassName MSPower_DeviceEnable -ErrorAction SilentlyContinue) { Get-CimInstance -Namespace root\wmi -ClassName MSPower_DeviceEnable | Where-Object Enable | ForEach-Object { $_.Enable = $false; Set-CimInstance -InputObject $_ } }"
